# starz_core/rcon/bootstrap.py
from __future__ import annotations

import discord

from config_starz import (
    RCON_CONFIGS,
    RCON_DISCONNECT_ALERT_CHANNEL_ID,
)
from starz_core.rcon.console_watch import RconConsoleWatchManager


def is_enabled() -> bool:
    return True


def set_printpos_enabled(enabled: bool) -> None:
    """
    Wire RCON stability â†’ PrintPos enable/disable.
    Canonical tracker currently lives in starz_printpos.tp_tracker and uses set_enabled().
    """
    try:
        # If you later move tp_tracker into starz_core, this will work
        from starz_core.printpos.tp_tracker import set_enabled as _set  # type: ignore
        _set(bool(enabled))
        return
    except Exception:
        pass

    # Current canonical location
    from starz_printpos.tp_tracker import set_enabled as _set  # type: ignore
    _set(bool(enabled))


async def start_rcon_system(bot: discord.Client) -> None:
    mgr = RconConsoleWatchManager(
        bot=bot,
        rcon_configs=RCON_CONFIGS,
        is_enabled=is_enabled,
        disconnect_channel_id=RCON_DISCONNECT_ALERT_CHANNEL_ID,
        set_printpos_enabled=set_printpos_enabled,  # optional
    )
    mgr.start()
    print("[STARZ-RCON] RCON console watch started")

    # Start playerlist polling so PrintPos gets online player updates
    from starz_core.rcon.playerlist_poll import start_playerlist_polling
    await start_playerlist_polling(RCON_CONFIGS.keys())
