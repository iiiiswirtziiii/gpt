# starz_core/commands/tps/zones/zone_list.py
from __future__ import annotations

import discord
from discord import app_commands
from discord.ext import commands


@app_commands.command(
    name="tp-list-zones",
    description="List saved TP zones (type/slot/coords/spawn count).",
)
async def tp_list_zones(interaction: discord.Interaction) -> None:
    # Imports inside to avoid circular issues during refactor
    try:
        try:
            from starz_core.printpos.tp_zones import get_all_zones  # if moved later
        except Exception:
            from starz_printpos.tp_zones import get_all_zones  # canonical now
    except Exception as e:
        await interaction.response.send_message(
            f"âŒ Could not import get_all_zones: {e}",
            ephemeral=True,
        )
        return

    try:
        zones = list(get_all_zones())
    except Exception as e:
        await interaction.response.send_message(f"âŒ Failed to load zones: {e}", ephemeral=True)
        return

    if not zones:
        await interaction.response.send_message("â„¹ï¸ No TP zones saved yet.", ephemeral=True)
        return

    # Sort by type then slot if attributes exist
    def _key(z):
        return (getattr(z, "tp_type", ""), int(getattr(z, "slot", 0) or 0))

    zones.sort(key=_key)

    lines: list[str] = []
    for z in zones[:40]:  # prevent huge embeds
        tp_type = getattr(z, "tp_type", "unknown")
        slot = getattr(z, "slot", "?")
        x = float(getattr(z, "zone_x", 0.0) or 0.0)
        y = float(getattr(z, "zone_y", 0.0) or 0.0)
        zz = float(getattr(z, "zone_z", 0.0) or 0.0)

        spawns = getattr(z, "spawns", []) or []
        spawn_count = len(spawns) if isinstance(spawns, list) else 0

        lines.append(
            f"â€¢ `{tp_type}` slot `{slot}` @ `({x:.2f},{y:.2f},{zz:.2f})` spawns=`{spawn_count}`"
        )

    embed = discord.Embed(
        title="ðŸ“ Saved TP Zones",
        description="\n".join(lines),
        color=0x3498DB,
    )

    if len(zones) > 40:
        embed.set_footer(text=f"Showing first 40 of {len(zones)} zones")

    await interaction.response.send_message(embed=embed, ephemeral=True)


def setup(bot: commands.Bot) -> None:
    bot.tree.add_command(tp_list_zones)
