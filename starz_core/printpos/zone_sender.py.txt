# starz_core/printpos/zone_sender.py
from __future__ import annotations

import asyncio
import re
from typing import Iterable, List, Optional, Sequence

# Tune these if you want
ZONE_SEND_DELAY_SECONDS = 0.20      # delay between zone commands on the same server
ZONE_SERVER_GAP_SECONDS = 0.35      # delay between servers
VERIFY_AFTER_SEND = True            # do a basic verify by running zones.list and checking name
VERIFY_TIMEOUT_SECONDS = 8.0

# If your zone plugin outputs something specific you want to treat as failure:
FAIL_PAT = re.compile(r"(failed|error|exception|unknown command)", re.I)


def _normalize_server_keys(server_keys: Optional[Sequence[str]]) -> List[str]:
    if server_keys and len(server_keys) > 0:
        return list(server_keys)

    # Default list: only servers that exist in your RCON configs
    try:
        # You likely have this in config_starz
        from config_starz import RCON_CONFIGS  # type: ignore
        return list(RCON_CONFIGS.keys())
    except Exception:
        # Fallback: your older code sometimes had these explicitly
        try:
            from config_starz import ZONE_RCON_SERVER_KEYS  # type: ignore
            return list(ZONE_RCON_SERVER_KEYS)
        except Exception:
            # Last resort: no server keys provided and no config found
            return []


async def _rcon_send(server_key: str, cmd: str) -> str:
    """
    Unified RCON send wrapper.

    Tries:
      1) starz_core.rcon.rcon_web.rcon_send(server_key, cmd)
      2) rcon_web.rcon_send(server_key, cmd)

    Returns empty string if no response.
    """
    # Preferred: if you've refactored into starz_core/rcon
    try:
        from starz_core.rcon.rcon_web import rcon_send  # type: ignore
        resp = await rcon_send(server_key, cmd)
        return (resp or "").strip()
    except Exception:
        pass

    # Fallback: your older flat module name
    try:
        from rcon_web import rcon_send  # type: ignore
        resp = await rcon_send(server_key, cmd)
        return (resp or "").strip()
    except Exception as e:
        raise RuntimeError(f"RCON send not available ({type(e).__name__}): {e}")


async def _verify_zone_exists(server_key: str, zone_name: str) -> bool:
    """
    Lightweight verify: run zones.list and confirm zone_name appears in output.
    This depends on your zones plugin supporting zones.list.
    """
    try:
        resp = await asyncio.wait_for(_rcon_send(server_key, "zones.list"), timeout=VERIFY_TIMEOUT_SECONDS)
    except Exception:
        return False

    if not resp:
        return False

    return zone_name.lower() in resp.lower()


async def send_zone_setup_cmds(
    zone_name: str,
    cmds: Iterable[str],
    *,
    server_keys: Optional[Sequence[str]] = None,
    verify: bool = VERIFY_AFTER_SEND,
) -> int:
    """
    Send a list of Rust 'zones.*' commands to each server (multi-server).
    Returns total commands sent.

    - Continues on errors per server (does not abort whole batch).
    - Optional verify per server after sending (zones.list contains zone_name).
    """
    keys = _normalize_server_keys(server_keys)
    if not keys:
        raise RuntimeError("No RCON server keys available for zone sending (check RCON_CONFIGS).")

    cmd_list = [c.strip() for c in cmds if c and c.strip()]
    if not cmd_list:
        return 0

    total_sent = 0
    failures: List[str] = []

    for sk in keys:
        try:
            # Send all zone commands for this server
            for cmd in cmd_list:
                resp = await _rcon_send(sk, cmd)
                total_sent += 1

                # Basic failure detection (non-fatal; just track)
                if resp and FAIL_PAT.search(resp):
                    failures.append(f"{sk}: '{cmd}' -> {resp[:120]}")

                await asyncio.sleep(ZONE_SEND_DELAY_SECONDS)

            # Optional verify
            if verify:
                ok = await _verify_zone_exists(sk, zone_name)
                if not ok:
                    failures.append(f"{sk}: verify failed (zone not found in zones.list): {zone_name}")

        except Exception as e:
            failures.append(f"{sk}: exception: {type(e).__name__}: {e}")

        await asyncio.sleep(ZONE_SERVER_GAP_SECONDS)

    # If *everything* failed, raise (so your command can show a hard fail)
    if len(failures) >= len(keys) and total_sent == 0:
        raise RuntimeError("Zone setup failed for all servers: " + " | ".join(failures[:3]))

    # If partial failures happened, log them but donâ€™t crash (command already saved config)
    if failures:
        print("[TP-ZONES] Some zone send/verify issues:")
        for line in failures[:20]:
            print("  -", line)

    return total_sent
