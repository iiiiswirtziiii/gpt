from __future__ import annotations

from typing import Optional, List

import discord
from discord import app_commands

from config_starz import AI_CONTROL_ROLES

from starz_core.printpos.tp_zones import (
    upsert_zone_and_save,
    list_zone_summaries,
    remove_zone_and_save,
)
from starz_core.printpos.zone_sender import send_zone_setup_cmds


def _has_ai_control(interaction: discord.Interaction) -> bool:
    if not isinstance(interaction.user, discord.Member):
        return False
    return any(r.id in AI_CONTROL_ROLES for r in interaction.user.roles)


async def _reply(interaction: discord.Interaction, content: str, *, ephemeral: bool = True) -> None:
    if interaction.response.is_done():
        await interaction.followup.send(content, ephemeral=ephemeral)
    else:
        await interaction.response.send_message(content, ephemeral=ephemeral)


TP_TYPE_CHOICES = [
    app_commands.Choice(name="Launch Site", value="launch"),
    app_commands.Choice(name="Airfield", value="airfield"),
    app_commands.Choice(name="Harbor", value="harbor"),
    app_commands.Choice(name="Train Yard", value="trainyard"),
    app_commands.Choice(name="Junkyard", value="junkyard"),
    app_commands.Choice(name="Power Plant", value="powerplant"),
    app_commands.Choice(name="Water Treatment", value="watertreatment"),
    app_commands.Choice(name="Outpost", value="outpost"),
    app_commands.Choice(name="Bandit", value="bandit"),
]


@app_commands.command(name="tp-ping", description="Verify TP command system is online")
async def tp_ping(interaction: discord.Interaction):
    if not _has_ai_control(interaction):
        await _reply(interaction, "❌ You do not have permission.", ephemeral=True)
        return
    await _reply(interaction, "✅ TP commands module online.", ephemeral=True)


@app_commands.command(
    name="tp-set-zone",
    description="Create/update a TP trigger zone for a monument type (and spawn points).",
)
@app_commands.choices(tp_type=TP_TYPE_CHOICES)
@app_commands.describe(
    zone_x="Zone center X",
    zone_y="Zone center Y",
    zone_z="Zone center Z",
    spawn1='Spawn #1 as "x,y,z"',
    spawn2='Spawn #2 as "x,y,z" (optional)',
    spawn3='Spawn #3 as "x,y,z" (optional)',
    spawn4='Spawn #4 as "x,y,z" (optional)',
    spawn5='Spawn #5 as "x,y,z" (optional)',
)
async def tp_set_zone(
    interaction: discord.Interaction,
    tp_type: app_commands.Choice[str],
    zone_x: float,
    zone_y: float,
    zone_z: float,
    spawn1: str,
    spawn2: Optional[str] = None,
    spawn3: Optional[str] = None,
    spawn4: Optional[str] = None,
    spawn5: Optional[str] = None,
):
    if not _has_ai_control(interaction):
        await _reply(interaction, "❌ You do not have permission to set TP zones.", ephemeral=True)
        return

    await _reply(interaction, "⏳ Saving TP zone + pushing to servers…", ephemeral=True)

    spawns: List[str] = [spawn1]
    for s in (spawn2, spawn3, spawn4, spawn5):
        if s:
            spawns.append(s)

    # Save + build zone commands
    zone_name, zone_cmds = upsert_zone_and_save(
        tp_type=tp_type.value,
        zone_x=zone_x,
        zone_y=zone_y,
        zone_z=zone_z,
        spawns=spawns,
        slot=1,
    )

    # Push to servers (multi-server safe)
    sent = await send_zone_setup_cmds(zone_name=zone_name, cmds=zone_cmds)

    await _reply(
        interaction,
        (
            f"✅ TP zone updated for **{tp_type.name}**\n"
            f"• Zone: `{zone_name}` @ ({zone_x:.2f}, {zone_y:.2f}, {zone_z:.2f})\n"
            f"• Spawns: `{len(spawns)}`\n"
            f"• RCON: sent `{sent}` commands"
        ),
        ephemeral=True,
    )


@app_commands.command(name="tp-list", description="List saved TP zones")
async def tp_list(interaction: discord.Interaction):
    if not _has_ai_control(interaction):
        await _reply(interaction, "❌ You do not have permission.", ephemeral=True)
        return

    lines = list_zone_summaries()
    if not lines:
        await _reply(interaction, "No TP zones saved yet.", ephemeral=True)
        return

    # Discord message size safety
    text = "\n".join(f"• {ln}" for ln in lines)
    if len(text) > 1800:
        text = text[:1800] + "\n…(truncated)"

    await _reply(interaction, f"✅ Saved TP zones:\n{text}", ephemeral=True)


@app_commands.command(name="tp-remove", description="Remove a TP zone and push removal to servers")
@app_commands.choices(tp_type=TP_TYPE_CHOICES)
@app_commands.describe(slot="Zone slot (default 1)")
async def tp_remove(
    interaction: discord.Interaction,
    tp_type: app_commands.Choice[str],
    slot: Optional[int] = 1,
):
    if not _has_ai_control(interaction):
        await _reply(interaction, "❌ You do not have permission.", ephemeral=True)
        return

    await _reply(interaction, "⏳ Removing TP zone + pushing removal to servers…", ephemeral=True)

    # Remove from config
    zone_name = remove_zone_and_save(tp_type=tp_type.value, slot=int(slot or 1))

    # Push remove command to servers
    remove_cmds = [f'zones.remove "{zone_name}"']
    sent = await send_zone_setup_cmds(zone_name=zone_name, cmds=remove_cmds, verify=False)

    await _reply(
        interaction,
        f"✅ Removed `{zone_name}` and sent `{sent}` removal commands.",
        ephemeral=True,
    )


def setup(tree: app_commands.CommandTree) -> None:
    tree.add_command(tp_ping)
    tree.add_command(tp_set_zone)
    tree.add_command(tp_list)
    tree.add_command(tp_remove)
    print("[STARZ-COMMANDS] TP commands registered")
