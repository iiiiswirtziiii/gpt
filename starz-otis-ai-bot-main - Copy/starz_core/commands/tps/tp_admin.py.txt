# starz_core/commands/tps/tp_admin.py
from __future__ import annotations

import discord
from discord import app_commands
from discord.ext import commands

from config_starz import AI_CONTROL_ROLES


def _has_ai_control(member: discord.Member) -> bool:
    roles = getattr(member, "roles", []) or []
    allowed = set(AI_CONTROL_ROLES)
    return any(getattr(r, "id", None) in allowed for r in roles)


@app_commands.command(name="tp-status", description="Show TP/PrintPos status + loaded zones.")
async def tp_status(interaction: discord.Interaction) -> None:
    # Anyone can view status

    # tracker enabled?
    enabled = None
    try:
        from starz_printpos.tp_tracker import is_enabled as tp_is_enabled
        enabled = bool(tp_is_enabled())
    except Exception:
        enabled = None

    # zones loaded?
    zone_count = None
    try:
        try:
            from starz_core.printpos.tp_zones import get_all_zones  # if you moved it later
        except Exception:
            from starz_printpos.tp_zones import get_all_zones  # canonical currently

        zone_count = len(list(get_all_zones()))
    except Exception:
        zone_count = None

    embed = discord.Embed(
        title="ðŸ›°ï¸ TP / PrintPos Status",
        color=0x2ECC71 if enabled else 0xE67E22,
    )
    embed.add_field(
        name="PrintPos Enabled",
        value=str(enabled) if enabled is not None else "unknown",
        inline=True,
    )
    embed.add_field(
        name="Loaded Zones",
        value=str(zone_count) if zone_count is not None else "unknown",
        inline=True,
    )

    await interaction.response.send_message(embed=embed, ephemeral=True)


@app_commands.command(name="tp-toggle", description="Enable/disable TP/PrintPos polling (AI control only).")
@app_commands.describe(enabled="true = enable, false = disable")
async def tp_toggle(interaction: discord.Interaction, enabled: bool) -> None:
    # Permission gate
    if not isinstance(interaction.user, discord.Member) or not _has_ai_control(interaction.user):
        await interaction.response.send_message("âŒ You do not have permission to toggle TP.", ephemeral=True)
        return

    try:
        from starz_printpos.tp_tracker import set_enabled
    except Exception:
        await interaction.response.send_message("âŒ TP tracker not available (import failed).", ephemeral=True)
        return

    try:
        set_enabled(bool(enabled))
    except Exception as e:
        await interaction.response.send_message(f"âŒ Failed to toggle TP: {e}", ephemeral=True)
        return

    await interaction.response.send_message(
        f"âœ… TP / PrintPos is now **{'ENABLED' if enabled else 'DISABLED'}**.",
        ephemeral=True,
    )


def setup(bot: commands.Bot) -> None:
    bot.tree.add_command(tp_status)
    bot.tree.add_command(tp_toggle)
