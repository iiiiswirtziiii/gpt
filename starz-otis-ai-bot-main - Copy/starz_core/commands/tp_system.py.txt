# starz_core/commands/tp_system.py
from __future__ import annotations

import re
from typing import Dict, List, Optional, Tuple

import discord
from discord import app_commands
from discord.ext import commands

# Pull the canonical TP system from starz_printpos
from starz_printpos import (
    TPType,
    set_tp_zone,
    clear_tp_type,
)
from starz_printpos.tp_zones import (
    DEFAULT_ZONE_COLORS,
    get_configured_tp_types,
    get_configured_slots,
)

# -------------------------
# Module globals (set in init())
# -------------------------
_send_rcon = None  # async fn(server_key: str, cmd: str) -> str|None
AI_CONTROL_ROLES: List[int] = []
ZONE_RCON_SERVER_KEYS: List[str] = []

# per-user clipboard (discord_user_id -> list of (x,y,z))
TP_SPAWN_CLIPBOARD: Dict[int, List[Tuple[float, float, float]]] = {}

# -------------------------
# Friendly names / messages
# -------------------------
FRIENDLY_TP_NAMES: Dict[TPType, str] = {
    TPType.LAUNCHSITE: "Launchsite",
    TPType.AIRFIELD: "Airfield",
    TPType.JUNKYARD: "Junkyard",
    TPType.OXUMS_GAS_STATION: "Oxums Gas Station",
    TPType.WATER_TREATMENT_PLANT: "Water Treatment Plant",
    TPType.BANDIT_CAMP: "Bandit Camp",
    TPType.OUTPOST: "Outpost",
    TPType.FISHING_VILLAGE: "Fishing Village",
    TPType.MILLITARY_TUNNELS: "Military Tunnels",
    TPType.ABANDONED_MILITARY_BASE: "Abandoned Military Base",
}

TP_ENTER_MESSAGES: Dict[TPType, str] = {
    tp: f"Teleporting via {name} zone..." for tp, name in FRIENDLY_TP_NAMES.items()
}
TP_EXIT_MESSAGES: Dict[TPType, str] = {
    tp: f"You have left the {name} zone." for tp, name in FRIENDLY_TP_NAMES.items()
}

# Rust zones plugin expects 0/1 style floats in many configs; keep it simple:
ZONE_COLOR_RGB: Dict[str, Tuple[int, int, int]] = {
    "WHITE": (1, 1, 1),
    "RED": (1, 0, 0),
    "GREEN": (0, 1, 0),
    "BLUE": (0, 0, 1),
    "YELLOW": (1, 1, 0),
    "CYAN": (0, 1, 1),
    "MAGENTA": (1, 0, 1),
    "ORANGE": (1, 1, 0),  # close enough
    "PURPLE": (1, 0, 1),
    "GRAY": (1, 1, 1),
    "BLACK": (0, 0, 0),
}

# -------------------------
# Helpers
# -------------------------
def _has_ai_perm(user: discord.abc.User) -> bool:
    if not isinstance(user, discord.Member):
        return False
    return any(r.id in AI_CONTROL_ROLES for r in user.roles)

_spawn_re = re.compile(r"^\s*(-?\d+(?:\.\d+)?)\s+(-?\d+(?:\.\d+)?)\s+(-?\d+(?:\.\d+)?)\s*$")

def _parse_spawn(s: str) -> Tuple[float, float, float]:
    m = _spawn_re.match((s or "").strip())
    if not m:
        raise ValueError('Spawn must be in format: "x y z" (spaces between numbers)')
    return (float(m.group(1)), float(m.group(2)), float(m.group(3)))

async def _send_zone_setup_cmds(cmds: List[str]) -> int:
    """
    Sends each command to each server in ZONE_RCON_SERVER_KEYS.
    Returns how many commands were sent total.
    """
    global _send_rcon
    if _send_rcon is None:
        raise RuntimeError("TP system not initialized: missing send_rcon")

    total = 0
    for server_key in ZONE_RCON_SERVER_KEYS:
        for cmd in cmds:
            try:
                await _send_rcon(server_key, cmd)
                total += 1
            except Exception as e:
                print(f"[TP-ZONES] RCON send failed server={server_key} cmd={cmd!r} err={e}")
    return total

def _tp_type_choices() -> List[app_commands.Choice[str]]:
    # Use Enum values (strings) for choices
    out: List[app_commands.Choice[str]] = []
    for tp in TPType:
        out.append(app_commands.Choice(name=tp.value.title().replace("_", " "), value=tp.value))
    return out

TP_TYPE_CHOICES = _tp_type_choices()

# -------------------------
# Public init + register
# -------------------------
def init_tp_system(
    *,
    send_rcon,
    ai_control_roles: List[int],
    zone_rcon_server_keys: List[str],
) -> None:
    global _send_rcon, AI_CONTROL_ROLES, ZONE_RCON_SERVER_KEYS
    _send_rcon = send_rcon
    AI_CONTROL_ROLES = list(ai_control_roles or [])
    ZONE_RCON_SERVER_KEYS = list(zone_rcon_server_keys or [])
    print(f"[TP-CMD] Initialized tp_system. servers={len(ZONE_RCON_SERVER_KEYS)} ai_roles={len(AI_CONTROL_ROLES)}")

def register_commands(bot: commands.Bot) -> None:
    tree = bot.tree

    # -------------------------
    # /tp-clipboard
    # -------------------------
    @tree.command(name="tp-clipboard", description="Show your saved TP spawn clipboard (from /tp-set-zone).")
    async def tp_clipboard(interaction: discord.Interaction):
        if not _has_ai_perm(interaction.user):
            await interaction.response.send_message("‚ùå No permission.", ephemeral=True)
            return

        spawns = TP_SPAWN_CLIPBOARD.get(interaction.user.id) or []
        if not spawns:
            await interaction.response.send_message(
                "üìã **TP Clipboard is empty**\nRun **/tp-set-zone** first to save spawn points.",
                ephemeral=True,
            )
            return

        lines = [f"`#{i}` ‚Üí **X:** `{x:.2f}` **Y:** `{y:.2f}` **Z:** `{z:.2f}`" for i, (x, y, z) in enumerate(spawns, 1)]
        embed = discord.Embed(
            title="üìã TP Spawn Clipboard",
            description="\n".join(lines),
            color=0xE67E22,
        )
        embed.set_footer(text=f"Saved spawns: {len(spawns)} ‚Ä¢ Use /tp-copy-zone to reuse")
        await interaction.response.send_message(embed=embed, ephemeral=True)

    # -------------------------
    # /tp-set-zone
    # -------------------------
    @tree.command(name="tp-set-zone", description="Set a teleport zone and up to 5 teleport spawn positions.")
    @app_commands.describe(
        tp_type="Type of teleport (Launch Site, Airfield, etc.)",
        zone_x="Zone X (where they walk to trigger the TP).",
        zone_y="Zone Y.",
        zone_z="Zone Z.",
        spawn1="Spawn 1 position as: x y z",
        spawn2="Spawn 2 position as: x y z (optional)",
        spawn3="Spawn 3 position as: x y z (optional)",
        spawn4="Spawn 4 position as: x y z (optional)",
        spawn5="Spawn 5 position as: x y z (optional)",
    )
    @app_commands.choices(tp_type=TP_TYPE_CHOICES)
    async def tp_set_zone(
        interaction: discord.Interaction,
        tp_type: app_commands.Choice[str],
        zone_x: float,
        zone_y: float,
        zone_z: float,
        spawn1: str,
        spawn2: Optional[str] = None,
        spawn3: Optional[str] = None,
        spawn4: Optional[str] = None,
        spawn5: Optional[str] = None,
    ):
        if not _has_ai_perm(interaction.user):
            await interaction.response.send_message("‚ùå You do not have permission to set TP zones.", ephemeral=True)
            return

        await interaction.response.defer(ephemeral=True)

        tp_enum = TPType(tp_type.value)

        # parse spawns
        spawns: List[Tuple[float, float, float]] = []
        for s in [spawn1, spawn2, spawn3, spawn4, spawn5]:
            if not s:
                continue
            spawns.append(_parse_spawn(s))

        # Save clipboard for this user
        TP_SPAWN_CLIPBOARD[interaction.user.id] = spawns

        # messages + color
        enter_msg = TP_ENTER_MESSAGES.get(tp_enum, f"Teleporting via {tp_enum.value} zone...")
        exit_msg = TP_EXIT_MESSAGES.get(tp_enum, f"You have left the {tp_enum.value} zone.")
        final_color = DEFAULT_ZONE_COLORS.get(tp_enum.value, "WHITE")

        # Clear existing slots for this type
        try:
            clear_tp_type(tp_enum)
        except Exception as e:
            print(f"[TP-ZONES] Failed to clear zones for {tp_enum.value}: {e}")

        # store each spawn as a slot (slot 1..N)
        created_slots = 0
        for slot_idx, (dx, dy, dz) in enumerate(spawns, start=1):
            set_tp_zone(
                tp_enum,
                slot_idx,
                zone_x,
                zone_y,
                zone_z,
                dx,
                dy,
                dz,
                color=final_color,
                enter_message=enter_msg,
                exit_message=exit_msg,
                spawn_points=spawns,
            )
            created_slots += 1

        # Build Rust zones plugin commands
        friendly = FRIENDLY_TP_NAMES.get(tp_enum, tp_enum.value.title())
        zone_name = f"{tp_enum.value} MAIN"

        r, g, b = ZONE_COLOR_RGB.get(final_color, (1, 1, 1))
        enter_html = (enter_msg or "").replace('"', "'")
        leave_html = (exit_msg or "").replace('"', "'")

        # Your in-game ‚Äúzone looks wrong‚Äù fix: keep bot zone_y, bump rust display slightly
        zone_y_for_rust = zone_y + 0.75

        delete_cmds = [f'zones.removecustomzone "{zone_name}"']

        create_cmds = [
            f'zones.createcustomzone "{zone_name}" ({zone_x},{zone_y_for_rust},{zone_z}) 120 sphere 1.5 1 {r} {g} {b} 1',
            f'zones.setcustomzoneentertext "{zone_name}" "{enter_html}"',
            f'zones.setcustomzoneexittext "{zone_name}" "{leave_html}"',
        ]

        sent = 0
        try:
            sent += await _send_zone_setup_cmds(delete_cmds)
            sent += await _send_zone_setup_cmds(create_cmds)
        except Exception as e:
            await interaction.followup.send(f"‚ö†Ô∏è Saved bot TP zones, but RCON zone setup failed: `{e}`", ephemeral=True)
            return

        await interaction.followup.send(
            f"‚úÖ **{friendly} zone updated**\n"
            f"- Slots saved: **{created_slots}**\n"
            f"- Clipboard saved: **{len(spawns)}** spawn points\n"
            f"- RCON cmds sent: **{sent}**",
            ephemeral=True,
        )

    # -------------------------
    # /tp-copy-zone  (reuse clipboard)
    # -------------------------
    @tree.command(name="tp-copy-zone", description="Create a TP zone using your last saved spawn points (clipboard).")
    @app_commands.describe(
        tp_type="Which monument type you are creating the trigger zone for",
        zone_x="Trigger zone center X",
        zone_y="Trigger zone center Y",
        zone_z="Trigger zone center Z",
    )
    @app_commands.choices(tp_type=TP_TYPE_CHOICES)
    async def tp_copy_zone(
        interaction: discord.Interaction,
        tp_type: app_commands.Choice[str],
        zone_x: float,
        zone_y: float,
        zone_z: float,
    ):
        if not _has_ai_perm(interaction.user):
            await interaction.response.send_message("‚ùå You do not have permission to set TP zones.", ephemeral=True)
            return

        await interaction.response.defer(ephemeral=True)

        spawns = TP_SPAWN_CLIPBOARD.get(interaction.user.id) or []
        if not spawns:
            await interaction.followup.send(
                "‚ùå No saved spawn points yet.\nRun **/tp-set-zone** once first, then use **/tp-copy-zone**.",
                ephemeral=True,
            )
            return

        tp_enum = TPType(tp_type.value)

        enter_msg = TP_ENTER_MESSAGES.get(tp_enum, f"Teleporting via {tp_enum.value} zone...")
        exit_msg = TP_EXIT_MESSAGES.get(tp_enum, f"You have left the {tp_enum.value} zone.")
        final_color = DEFAULT_ZONE_COLORS.get(tp_enum.value, "WHITE")

        try:
            clear_tp_type(tp_enum)
        except Exception as e:
            print(f"[TP-ZONES] Failed to clear zones for {tp_enum.value}: {e}")

        created_slots = 0
        for slot_idx, (dx, dy, dz) in enumerate(spawns, start=1):
            set_tp_zone(
                tp_enum,
                slot_idx,
                zone_x,
                zone_y,
                zone_z,
                dx,
                dy,
                dz,
                color=final_color,
                enter_message=enter_msg,
                exit_message=exit_msg,
                spawn_points=spawns,
            )
            created_slots += 1

        zone_name = f"{tp_enum.value} MAIN"
        r, g, b = ZONE_COLOR_RGB.get(final_color, (1, 1, 1))
        enter_html = (enter_msg or "").replace('"', "'")
        leave_html = (exit_msg or "").replace('"', "'")
        zone_y_for_rust = zone_y + 0.75

        delete_cmds = [f'zones.removecustomzone "{zone_name}"']
        create_cmds = [
            f'zones.createcustomzone "{zone_name}" ({zone_x},{zone_y_for_rust},{zone_z}) 120 sphere 1.5 1 {r} {g} {b} 1',
            f'zones.setcustomzoneentertext "{zone_name}" "{enter_html}"',
            f'zones.setcustomzoneexittext "{zone_name}" "{leave_html}"',
        ]

        sent = 0
        sent += await _send_zone_setup_cmds(delete_cmds)
        sent += await _send_zone_setup_cmds(create_cmds)

        await interaction.followup.send(
            f"‚úÖ **{tp_enum.value} copied from clipboard**\n"
            f"- Slots saved: **{created_slots}**\n"
            f"- RCON cmds sent: **{sent}**",
            ephemeral=True,
        )

    # -------------------------
    # /tp-clear-type
    # -------------------------
    @tree.command(name="tp-clear-type", description="Clear ALL slots for a TP type (bot-side).")
    @app_commands.describe(tp_type="Which tp_type to clear")
    @app_commands.choices(tp_type=TP_TYPE_CHOICES)
    async def tp_clear_type(interaction: discord.Interaction, tp_type: app_commands.Choice[str]):
        if not _has_ai_perm(interaction.user):
            await interaction.response.send_message("‚ùå No permission.", ephemeral=True)
            return

        tp_enum = TPType(tp_type.value)
        removed = 0
        try:
            removed = clear_tp_type(tp_enum)
        except Exception as e:
            await interaction.response.send_message(f"‚ùå Failed: `{e}`", ephemeral=True)
            return

        await interaction.response.send_message(f"‚úÖ Cleared **{tp_enum.value}** (removed **{removed}** slots).", ephemeral=True)

    # -------------------------
    # /tp-status
    # -------------------------
    @tree.command(name="tp-status", description="Show configured TP types + slots.")
    async def tp_status(interaction: discord.Interaction):
        if not _has_ai_perm(interaction.user):
            await interaction.response.send_message("‚ùå No permission.", ephemeral=True)
            return

        types = get_configured_tp_types()
        if not types:
            await interaction.response.send_message("No TP zones configured yet.", ephemeral=True)
            return

        lines = []
        for t in types:
            slots = get_configured_slots(t)
            lines.append(f"**{t}** ‚Üí slots: `{', '.join(map(str, slots))}`")

        embed = discord.Embed(title="üìç TP Zone Status", description="\n".join(lines), color=0x3498DB)
        await interaction.response.send_message(embed=embed, ephemeral=True)

    print("[TP-CMD] Registered TP slash commands.")
