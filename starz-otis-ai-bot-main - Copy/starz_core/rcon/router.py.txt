# starz_core/rcon/router.py
from __future__ import annotations


async def handle_rcon_console_line(
    bot,
    *,
    server_key: str,
    msg_text: str,
    created_at_ts: float,
) -> None:
    """
    Unified fan-out router for each WebRCON console line.

    Keep this file THIN:
    - It only forwards the line to other modules
    - No heavy logic here
    - Imports inside the function to avoid circular imports
    """

    # 0) PrintPos console-line support (matches queued player names -> coords)
    # Safe to call on every line: it exits immediately if disabled / no match / no pending name.
    try:
        from starz_printpos.tp_tracker import handle_printpos_console_line
        await handle_printpos_console_line(server_key, msg_text)
    except Exception:
        pass

    # 1) Admin promotion watch (runs on every console line)
    try:
        from admin_promotion_watch import maybe_handle_admin_promotion
        await maybe_handle_admin_promotion(
            bot=bot,
            server_key=server_key,
            console_line=msg_text,
            created_at_ts=created_at_ts,
        )
    except Exception:
        # Keep RCON stream alive even if a module is mid-refactor or errors.
        pass

    # 2) Admin monitor + promoter monitor (only if matching ids exist)
    try:
        from admin_mon_system import (
            find_matching_admin_ids_from_text,
            log_admin_activity_for_ids,
        )
    except Exception:
        return

    try:
        matching_admin_ids = find_matching_admin_ids_from_text(msg_text)
    except Exception:
        return

    if not matching_admin_ids:
        return

    # 3) Admin activity logging (spawns / joins / etc)
    try:
        await log_admin_activity_for_ids(
            bot=bot,
            server_key=server_key,
            admin_ids=matching_admin_ids,
            raw_console_line=msg_text,
            created_at_ts=created_at_ts,
        )
    except Exception:
        pass

    # 4) Promoter monitoring
    try:
        from promoter_mon_system import maybe_handle_promoter_spawn
        await maybe_handle_promoter_spawn(
            bot=bot,
            server_key=server_key,
            raw_console_line=msg_text,
            created_at_ts=created_at_ts,
        )
    except Exception:
        pass
